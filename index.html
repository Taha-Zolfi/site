<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taha Zolfi</title>

    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØª Ø§ØµÙ„ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            margin: 0;
            overflow-x: hidden;
            font-family: 'open sans';
            background-color: black;
        }

        html,
        body {
            scroll-behavior: smooth;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgb(0, 0, 0);
        }

        ::-webkit-scrollbar-thumb {
            background: #00ffa7;
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .nav {
            position: fixed;
            width: 100%;
            background: rgba(0, 0, 0, 0.37);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-bottom: 1px solid #9ba3b446;
            z-index: 1000;
            display: flex;
            justify-content: center;
            border-end-end-radius: 15px;
            border-end-start-radius: 15px;
            box-shadow: 0 4px 30px rgba(255, 255, 255, 0.055);
            transition: opacity 0.5s ease;
        }

        .nav.hidden {
            opacity: 0;
        }

        .nav ul {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .nav ul li {
            display: inline-block;
            padding: 0.7rem 1.7rem;
        }

        .nav ul li a {
            font-weight: 100;
            font-size: 30px;
            padding: 19px 16px;
            cursor: pointer;
            position: relative;
            color: #e9eaeb81;
            text-decoration: none;
        }

        li a:hover {
            color: #e9eaeb;
        }

        li a::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            border-radius: 114px;
            background-color: #00ffa7;
            bottom: 15px;
            left: 0;
            transform-origin: right;
            transform: scaleX(0);
            transition: transform .3s ease-in-out;
        }

        li a:hover::before {
            transform-origin: left;
            transform: scaleX(1);
        }

        .next {
            height: 70vh;
            background: #0e0e0e;
            color: #e9eaeb;
            --gap: 5em;
            --line: 1px;
            --color: rgba(255, 255, 255, 0.2);
            background-image: linear-gradient(-90deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap)), linear-gradient(0deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap));
            background-size: var(--gap) var(--gap);
        }

        h1 {
            font-size: 5vw;
            font-weight: 900;
            padding-bottom: 2rem;
            padding-top: 2rem;
            text-align: center;
        }

        .next p {
            padding: 2rem;
            width: 50vw;
            font-weight: 600;
            font-size: larger;
            text-align: center;
            line-height: 1.4;
            color: #9ba3b4;
        }

        .third {
            height: auto;
            background: #0e0e0e;
            color: #e9eaeb;
            --gap: 5em;
            --line: 1px;
            --color: rgba(255, 255, 255, 0.2);
            background-image: linear-gradient(-90deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap)), linear-gradient(0deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap));
            background-size: var(--gap) var(--gap);
        }

        .fourth {
            height: 70vh;
            background: #0e0e0e;
            color: #e9eaeb;
            --gap: 5em;
            --line: 1px;
            --color: rgba(255, 255, 255, 0.2);
            background-image: linear-gradient(-90deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap)), linear-gradient(0deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap));
            background-size: var(--gap) var(--gap);
        }

        .fourth img {
            width: 4vw;
            margin: 2rem;
        }

        .m {
            display: flex;
            justify-content: center;
            padding: 1rem;
        }

        .fifth {
            color: white;
            background-color: #000000;
        }

        .c h1 {
            display: inline-block;
            position: relative;
            padding: 1rem 2rem;
            color: #e9eaeb;
            z-index: 1;
            font-size: 5vw;
            text-align: center;
            transition: all 0.3s ease-in-out;
        }

        .c h1::before {
            content: '';
            position: absolute;
            bottom: 15px;
            width: 100%;
            height: 4px;
            z-index: -1;
            left: 0;
            right: 0;
            background: #00ffa7;
            border-radius: 15px;
            transition: all 0.3s ease-in-out;
        }

        .c h1:hover {
            color: #0e0e0e;
            -webkit-text-stroke: 3px #00ffa7;
        }

        .c h1:hover::before {
            height: 50%;
            bottom: 0;
            filter: drop-shadow(0 0 15px #00ffa7);
        }

        .c {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        strong {
            color: #00ffa7;
        }

        .swiper img {
            width: 20vw;
            border-radius: 15px;
        }

        @media (orientation: portrait) {
            .nav {
                display: none;
            }

            .next p {
                width: 90vw;
            }

            .next {
                height: max-content;
            }

            .next h1 {
                font-size: 8vw;
            }

            .c h1 {
                display: inline-block;
                position: relative;
                padding: 1.5rem;
                color: #e9eaeb;
                z-index: 1;
                font-size: 9vw;
                text-align: center;
                transition: all 0.3s ease-in-out;
            }

            .fourth {
                height: 50vh;
            }

            .c h1::before {
                content: '';
                position: absolute;
                bottom: 15px;
                width: 100%;
                height: 4px;
                z-index: -1;
                left: 0;
                right: 0;
                background: #00ffa7;
                border-radius: 10px;
                transition: all 0.3s ease-in-out;
            }

            .c h1:hover {
                color: #0e0e0e;
                -webkit-text-stroke: 1px #00ffa7;
            }

            .c h1:hover::before {
                height: 50%;
                bottom: 0;
                filter: drop-shadow(0 0 15px #00ffa7);
            }

            .fourth img {
                width: 10vw;
                margin: 0.7rem;
            }

            .swiper img {
                width: 30vw;
                border-radius: 8px;
            }

            #d {
                display: none;
            }

            .m {
                display: flex;
                flex-direction: column;
            }

            .p1 {
                display: flex;
                justify-content: center;
            }
        }

        .column {
            width: 20%;
            padding: 0 10px;
        }

        .row {
            margin: 15PX;
            display: flex;
            justify-content: center;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .card img {
            width: 5vw;
        }

        .card {
            color: #e9eaeb;
            padding: 25px;
            text-align: center;
            background-color: #0e0e0e;
            border: solid 1px #00ffa7;
            border-radius: 15px;
        }

        .card h3 {
            color: #00ffa7;
            padding: 1rem;
        }

        @media screen and (max-width: 600px) {
            .column {
                width: 100%;
                display: block;
                margin-bottom: 20px;
            }

            .row {
                flex-direction: column;
            }

            .column h3 {
                display: none;
            }

            .card {
                display: flex;
                align-items: center;
                font-size: larger;
            }

            .card img {
                width: 10vw;
                margin-right: 1rem;
            }

            h1 {
                font-size: 9vw;
            }
        }

        /* -------------------------------------------------------------------
           PREMIUM SECRET SYSTEM STYLES (KETABINO)
           ------------------------------------------------------------------- */
        :root {
            --accent: #00ffa7;
            --accent-glow: rgba(0, 255, 167, 0.4);
            --bg-dark: #080808;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #efefef;
            --text-dim: #999;
        }

        #secret-container,
        #secret-container * {
            font-family: 'Vazirmatn', sans-serif !important;
        }

        #secret-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 100000;
            overflow: hidden;
            color: var(--text-main);
            direction: rtl;
        }

        /* Background Pattern Utility */
        .bg-pattern {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(var(--accent) 0.5px, transparent 0.5px),
                radial-gradient(var(--accent) 0.5px, var(--bg-dark) 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.03;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* === Premium Login === */
        #login-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #151515 0%, #050505 100%);
            padding: 24px;
            position: relative;
        }

        .login-card {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 2px;
            /* For the gradient border */
            border-radius: 40px;
            background: linear-gradient(135deg, var(--accent), transparent, #00d1ff);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.9);
            width: 100%;
            max-width: 460px;
            animation: cardEnter 1s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .login-card-inner {
            background: #080808;
            border-radius: 38px;
            padding: 50px 40px;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .ketabino-logo {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 5px;
            background: linear-gradient(180deg, #fff 40%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -2px;
            filter: drop-shadow(0 0 15px rgba(0, 255, 167, 0.3));
        }

        .login-subtitle {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .login-input {
            width: 100%;
            padding: 22px 24px;
            background: #111;
            border: 1px solid #222;
            border-radius: 20px;
            color: #fff;
            font-size: 1.4rem;
            text-align: center;
            outline: none;
            transition: all 0.4s;
            margin-bottom: 25px;
        }

        .login-input:focus {
            border-color: var(--accent);
            background: #151515;
            box-shadow: 0 0 30px rgba(0, 255, 167, 0.15);
            transform: translateY(-2px);
        }

        .login-btn {
            width: 100%;
            padding: 22px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 900;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            text-transform: uppercase;
        }

        .login-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 255, 167, 0.4);
            filter: brightness(1.1);
        }

        /* ============================================
           PROFESSIONAL CHAT APP REDESIGN - TELEGRAM/WHATSAPP STYLE
           ============================================ */

        #chat-view {
            display: none;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(180deg, #0d1117 0%, #161b22 100%);
            position: relative;
            overflow: hidden;
        }

        /* Chat Background - Clean Gradient */
        #chat-view::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(0, 255, 167, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 209, 255, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 255, 167, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }


        /* Premium Header */
        .chat-header {
            height: 65px;
            padding: 0 20px;
            background: linear-gradient(135deg, rgba(0, 255, 167, 0.1) 0%, rgba(0, 209, 255, 0.05) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 167, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: relative;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-info>div:first-child {
            font-size: 1.15rem;
            font-weight: 800;
            color: #fff;
            letter-spacing: 0.5px;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fff;
        }

        .header-logo {
            font-size: 0.85rem;
            font-weight: 900;
            color: #00ffa7;
            background: rgba(0, 255, 167, 0.1);
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 167, 0.3);
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #00ffa7;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ffa7, 0 0 20px #00ffa7;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }
        }

        /* Chat Messages Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
            position: relative;
            z-index: 1;
        }

        .chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 167, 0.3);
            border-radius: 10px;
        }

        /* Messages */
        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.5;
            animation: msgSlideIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        @keyframes msgSlideIn {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .msg-incoming {
            align-self: flex-start;
            background: linear-gradient(135deg, #1e2430 0%, #262d3a 100%);
            color: #e8e8e8;
            border-bottom-right-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .msg-outgoing {
            align-self: flex-end;
            background: linear-gradient(135deg, #00ffa7 0%, #00c896 100%);
            color: #0a0f0d;
            border-bottom-left-radius: 6px;
            font-weight: 500;
        }

        .msg-timer-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            margin-top: 6px;
            opacity: 0.6;
        }

        .msg-outgoing .msg-timer-wrap {
            justify-content: flex-end;
            color: #0a0f0d;
        }

        /* Read Receipts */
        .read-receipts {
            font-size: 0.75rem;
            margin-right: 4px;
            color: #00d4ff;
        }

        .msg-outgoing .read-receipts {
            color: #0a0f0d;
        }

        /* Reaction Animation */
        @keyframes reactionPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .msg-reaction {
            transition: transform 0.2s;
        }

        .msg-reaction:hover {
            transform: scale(1.2);
        }


        /* Message Images */
        .message img {
            max-width: 220px;
            max-height: 280px;
            border-radius: 12px;
            display: block;
            margin: 6px 0;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .message img:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        /* Reply Info in Messages */
        .msg-reply-info {
            background: rgba(0, 255, 167, 0.1);
            border-right: 3px solid #00ffa7;
            padding: 6px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .msg-reply-info:hover {
            background: rgba(0, 255, 167, 0.2);
        }

        .msg-reply-info .reply-sender {
            font-weight: 700;
            color: #00ffa7;
            font-size: 0.75rem;
            margin-bottom: 2px;
        }

        .msg-reply-info .reply-text-snippet {
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .msg-outgoing .msg-reply-info {
            background: rgba(0, 0, 0, 0.1);
            border-right-color: #0a0f0d;
        }

        .msg-outgoing .msg-reply-info .reply-sender,
        .msg-outgoing .msg-reply-info .reply-text-snippet {
            color: rgba(0, 0, 0, 0.7);
        }

        /* Typing Indicator */
        .typing-pill {
            margin: 0 20px 10px;
            padding: 10px 18px;
            background: rgba(0, 255, 167, 0.1);
            border: 1px solid rgba(0, 255, 167, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #00ffa7;
            width: fit-content;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Panic Button */
        #panic-footer {
            padding: 10px 16px;
            position: relative;
            z-index: 1;
        }

        .panic-btn-v2 {
            width: 100%;
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: #fff;
            border: none;
            padding: 14px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 59, 48, 0.35);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .panic-btn-v2:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 59, 48, 0.45);
        }

        /* Messages */
        #chat-area {
            flex: 1;
            padding: 20px 20px 80px 20px;
            /* Added padding-bottom to avoid overlap */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .reply-preview {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-top: 1px solid #00ffa7;
            display: none;
            z-index: 5;
            border-radius: 16px 16px 0 0;
            margin: 0 10px;
            transform: translateY(10px);
            animation: slideUp 0.3s forwards;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        .reply-preview .reply-text {
            font-size: 0.9rem;
            color: #00ffa7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-left: 30px;
        }

        .reply-preview .close-reply {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.1rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .reply-preview .close-reply:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Main Input Wrapper */
        .chat-input-wrapper {
            margin: 0 16px 16px;
            padding: 8px;
            background: linear-gradient(135deg, #1a1f2e 0%, #1e2433 100%);
            border: 1px solid rgba(0, 255, 167, 0.15);
            border-radius: 28px;
            position: relative;
            z-index: 10;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.3);
        }

        .input-container-inner {
            display: flex;
            align-items: center;
            gap: 4px;
            direction: ltr;
        }

        #msg-input {
            flex: 1;
            direction: rtl;
            text-align: right;
        }

        /* Action Buttons */
        .input-action-btn {
            width: 42px;
            height: 42px;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.3rem;
            border-radius: 50%;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
        }

        .input-action-btn:hover {
            color: #00ffa7;
            background: rgba(0, 255, 167, 0.1);
            transform: scale(1.1);
        }

        /* Text Input */
        #msg-input {
            flex: 1;
            min-width: 0;
            /* CRITICAL FIX FOR MOBILE */
            background: transparent;
            border: none;
            color: #fff;
            padding: 12px 8px;
            font-size: 1rem;
            outline: none;
            direction: rtl;
            text-align: right;
        }

        #msg-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Send Button - Special Styling */
        #send-btn {
            width: 46px;
            height: 46px;
            background: linear-gradient(135deg, #00ffa7 0%, #00c896 100%);
            color: #0a0f0d;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(0, 255, 167, 0.4);
            transition: all 0.3s ease;
        }

        #send-btn:hover {
            transform: scale(1.15) rotate(-15deg);
            box-shadow: 0 6px 25px rgba(0, 255, 167, 0.6);
        }



        @keyframes voicePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }


        /* Sticker/GIF Panel */
        .extra-panel {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 16px;
            right: 16px;
            background: linear-gradient(135deg, #1a1f2e 0%, #1e2433 100%);
            border: 1px solid rgba(0, 255, 167, 0.15);
            border-radius: 20px;
            height: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.4);
        }

        .extra-panel.active {
            height: 280px;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            gap: 12px;
        }

        .panel-tab {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 20px;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }

        .panel-tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .panel-tab.active {
            background: linear-gradient(135deg, #00ffa7 0%, #00c896 100%);
            color: #0a0f0d;
        }

        .panel-content {
            height: calc(100% - 60px);
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .panel-item {
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .panel-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .panel-item:hover {
            transform: scale(1.08);
            background: rgba(0, 255, 167, 0.1);
            border-color: rgba(0, 255, 167, 0.3);
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            background: linear-gradient(135deg, #1a1f2e 0%, #1e2433 100%);
            border: 1px solid rgba(0, 255, 167, 0.3);
            border-radius: 16px;
            padding: 10px;
            min-width: 200px;
            z-index: 9999999;
            display: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(0, 255, 167, 0.1);
            direction: rtl;
            animation: menuPop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }


        @keyframes menuPop {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.9);
        }

        .menu-item:hover {
            background: rgba(0, 255, 167, 0.15);
            color: #00ffa7;
        }

        .menu-item span {
            font-size: 1.1rem;
        }

        /* Image Modal */
        #image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        #image-modal img {
            max-width: 92vw;
            max-height: 92vh;
            border-radius: 12px;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.8);
            animation: modalZoom 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalZoom {
            from {
                transform: scale(0.6);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 1.8rem;
            color: #fff;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-close:hover {
            background: rgba(255, 59, 48, 0.3);
            border-color: #ff3b30;
            color: #ff3b30;
        }


        /* Float Notifications */
        .toast-notify {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 167, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 999999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: toastFadeIn 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: none;
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* Fix for mobile keyboard */
        @media (max-height: 500px) {
            .article-hero {
                padding: 40px 10px;
            }

            .ketabino-logo {
                font-size: 2.5rem;
            }
        }

        /* === Premium Article (Panic View) === */
        #panic-view {
            display: none;
            height: 100%;
            overflow-y: auto;
            background: #fff;
            color: #1a1a1a;
            direction: rtl;
        }

        .article-hero {
            background: #fafafa;
            padding: 100px 24px 70px;
            border-bottom: 1px solid #eee;
            margin-bottom: 50px;
            text-align: center;
        }

        .article-hero h1 {
            font-size: 3.5rem;
            font-weight: 950;
            color: #000;
            line-height: 1.1;
            margin-bottom: 25px;
            letter-spacing: -1px;
        }

        .article-meta-v2 {
            display: flex;
            gap: 20px;
            color: #999;
            font-size: 1.1rem;
            justify-content: center;
        }

        .article-content-v2 {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px 150px;
        }

        .article-content-v2 h2 {
            font-size: 2rem;
            font-weight: 800;
            margin: 60px 0 30px;
            color: #111;
            border-right: 5px solid var(--accent);
            padding-right: 20px;
        }

        .article-content-v2 p {
            font-size: 1.3rem;
            line-height: 2.2;
            margin-bottom: 30px;
            text-align: justify;
            color: #333;
        }

        .math-card-v2 {
            background: #f8f9fa;
            padding: 50px;
            border-radius: 30px;
            border: 1px solid #eee;
            text-align: center;
            margin: 50px 0;
            font-family: 'Times New Roman', serif !important;
            font-size: 2.5rem;
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
        }

        .math-card-v2::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            background: #3498db;
        }

        .article-return-btn {
            display: block;
            width: fit-content;
            margin: 60px auto 0;
            padding: 16px 40px;
            background: #000;
            color: #fff;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
        }

        .article-return-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: var(--accent);
            color: #000;
        }

        .fake-return-dot {
            margin-top: 20px;
            text-align: center;
            opacity: 0.01;
            cursor: pointer;
            padding: 20px;
            font-size: 1rem;
        }

        /* Trigger */
        .secret-trigger {
            width: 100%;
            background: #0e0e0e;
            padding: 40px 0;
            text-align: center;
        }

        .secret-trigger a {
            color: #00ffa7;
            text-decoration: none;
            font-weight: 800;
            font-size: 1.1rem;
            transition: 0.3s;
            opacity: 0.7;
        }

        .secret-trigger a:hover {
            opacity: 1;
            text-shadow: 0 0 15px var(--accent-glow);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>
    <!-- Main page content remains the same -->
    <div class="nav" id="blur">
        <ul>
            <li><a class="last" href="#canvas-container">HOME</a></li>
            <li><a class="last" href="#next">ABOUT ME</a></li>
            <li><a class="last" href="#third">PROJECTS</a></li>
            <li><a class="last" href="#fourth">SKILLS</a></li>
            <li><a class="last" href="#fifth">CONTACT</a></li>
        </ul>
    </div>
    <div id="canvas-container"></div>
    <script> AOS.init(); </script>
    <div id="next" class="next c">
        <h1>WHO AM I ?</h1>
        <p>Hello! I am an 18-year-old developer and graphic designer from iran with a passion for graphic design and
            programming...</p>
    </div>
    <div class="third " id="third">
        <h1>PROJECTS</h1>
        <div class="swiper">
            <div class="swiper-wrapper">
                <div class="swiper-slide"><a href="#"><img src="card1.jpg"></a></div>
                <div class="swiper-slide"><a href="#"><img src="card2.jpg"></a></div>
                <div class="swiper-slide"><a href="#"><img src="card3.jpg"></a></div>
                <div class="swiper-slide"><a href="#"><img src="card4.jpg"></a></div>
                <div class="swiper-slide"><a href="#"><img src="card5.jpg"></a></div>
            </div>
        </div>
    </div>
    <div class="fourth" id="fourth">
        <h1>SKILLS</h1>
        <div class="m">
            <div class="p1">
                <img src="imgs/l1.png" alt="Skill 1" data-aos="fade-up" data-aos-delay="100">
                <img src="imgs/l2.png" alt="Skill 2" data-aos="fade-up" data-aos-delay="200">
            </div>
        </div>
    </div>
    <div class="fifth" id="fifth">
        <h1>CONTACT ME</h1>
        <div class="row">
            <div class="column"><a href="#">
                    <div class="card"><img src="imgs/igg.png">
                        <h3>Instagram</h3>
                        <p>021gorb</p>
                    </div>
                </a></div>
            <div class="column"><a href="#">
                    <div class="card"><img src="imgs/tl.png">
                        <h3>Telegram</h3>
                        <p>Dr_coode</p>
                    </div>
                </a></div>
            <div class="column"><a href="#">
                    <div class="card"><img src="imgs/ph.png">
                        <h3>Number</h3>
                        <p>+989906648574</p>
                    </div>
                </a></div>
            <div class="column"><a href="#">
                    <div class="card"><img src="imgs/emm.png">
                        <h3>Email</h3>
                        <p>tahazolfi01@gmail.com</p>
                    </div>
                </a></div>
        </div>
    </div>
    <div class="secret-trigger">
        <a href="javascript:void(0)" onclick="openKetabino()">Ø±Ùˆ Ø§ÛŒÙ† Ø¨Ø²Ù†</a>
    </div>

    <!-- 
    =======================================================
                    SECRET KETABINO SYSTEM
    =======================================================
    -->
    <div id="secret-container">
        <!-- Premium Login -->
        <div id="login-view">
            <div class="bg-pattern" style="opacity: 0.05;"></div>
            <div class="login-card">
                <div class="login-card-inner">
                    <div class="ketabino-logo">Ú©ØªØ§Ø¨ÛŒÙ†Ùˆ</div>
                    <div class="login-subtitle">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¢Ù…ÙˆØ²Ø´ Ø­Ø³Ø§Ø¨Ø§Ù† Ùˆ Ø±ÛŒØ§Ø¶ÛŒØ§Øª ØªØ­Ù„ÛŒÙ„ÛŒ</div>
                    <div class="login-input-wrapper">
                        <input type="password" id="secret-pass" class="login-input" placeholder="Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"
                            maxlength="6">
                    </div>
                    <button class="login-btn" onclick="checkSecretPass()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡</button>
                    <p id="login-error"
                        style="color:#ff3b30; margin-top:20px; display:none; font-weight:bold; font-size:0.9rem;">Ú©Ø¯
                        Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª</p>
                </div>
            </div>
        </div>

        <!-- Premium Chat -->
        <div id="chat-view">
            <div class="chat-header">
                <div class="header-info">
                    <div class="chat-title">ğŸ’¬ Ú†Øª Ø®ØµÙˆØµÛŒ</div>
                    <div class="online-status">
                        <div class="online-dot"></div>
                        <span id="online-count">Û° Ù†ÙØ± Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                    </div>
                </div>
                <div class="header-logo">Ú©ØªØ§Ø¨ÛŒÙ†Ùˆ</div>
            </div>

            <div id="chat-area" class="chat-area" style="position: relative; z-index: 1;"></div>

            <div id="typing-status" class="typing-pill" style="position: relative; z-index: 1;"></div>

            <div id="panic-footer" style="position: relative; z-index: 1;">
                <button class="panic-btn-v2" onclick="triggerPanic()">
                    <span>âš </span> Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
                </button>
            </div>

            <div class="chat-input-wrapper" style="position: relative; z-index: 1;">
                <!-- Reply Preview (Inside Wrapper) -->
                <div id="reply-container" class="reply-preview">
                    <div class="close-reply" onclick="cancelReply()">âœ•</div>
                    <div id="reply-text" class="reply-text">Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡...</div>
                </div>

                <div class="input-container-inner">
                    <!-- Left side: Sticker & Attachment -->
                    <button id="sticker-btn" class="input-action-btn" onclick="toggleExtraPanel('stickers')">ğŸ˜Š</button>
                    <label for="file-upload" class="input-action-btn upload-trigger">ğŸ“</label>
                    <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="uploadImage()">

                    <!-- Middle: Text Input -->
                    <input type="text" id="msg-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">

                    <!-- Right side: Send Button -->
                    <button id="send-btn" class="input-action-btn" onclick="sendMessage()">â¤</button>


                </div>

                <!-- Sticker/GIF Panel -->
                <div id="extra-panel" class="extra-panel">
                    <div class="panel-tabs">
                        <div class="panel-tab active" onclick="switchPanelTab('stickers')">Ø§Ø³ØªÛŒÚ©Ø±</div>
                        <div class="panel-tab" onclick="switchPanelTab('gifs')">Ú¯ÛŒÙ</div>
                    </div>
                    <div id="panel-content" class="panel-content">
                        <!-- Items will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Article -->
        <div id="panic-view">
            <div class="article-hero">
                <div class="article-content-v2">
                    <div class="article-meta-v2">
                        <span>Ø¬Ù„Ø³Ù‡ Û±Û²: Ø¢Ù†Ø§Ù„ÛŒØ² Ø±ÛŒØ§Ø¶ÛŒ</span>
                        <span>â€¢</span>
                        <span>Ø¯Ú©ØªØ± Ø³Ù‡Ø±Ø§Ø¨ÛŒ</span>
                    </div>
                    <h1>Ù…Ø´ØªÙ‚ ØªÙˆØ§Ø¨Ø¹ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø¯Ø± Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ</h1>
                </div>
            </div>

            <div class="article-content-v2">
                <p>Ø¯Ø± Ø§ÛŒÙ† Ù…Ø¨Ø­Ø«ØŒ Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ù…ÙÙ‡ÙˆÙ… Ù…Ø´ØªÙ‚ Ùˆ Ù†Ù‚Ø´ Ø­ÛŒØ§ØªÛŒ Ø¢Ù† Ø¯Ø± ØªØ¹ÛŒÛŒÙ† Ø±ÙØªØ§Ø± ØªÙˆØ§Ø¨Ø¹ Ù…ÛŒâ€ŒÙ¾Ø±Ø¯Ø§Ø²ÛŒÙ…. Ù…Ø´ØªÙ‚ Ù†Ù‡ ØªÙ†Ù‡Ø§
                    Ø´ÛŒØ¨ Ø®Ø· Ù…Ù…Ø§Ø³ Ø¨Ù„Ú©Ù‡ Ù†Ø±Ø® ØªØºÛŒÛŒØ±Ø§Øª Ø¢Ù†ÛŒ Ø±Ø§ Ø¯Ø± Ù‡Ø± Ù„Ø­Ø¸Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>

                <h2>Û±. ØªØ¹Ø±ÛŒÙ ØµÙˆØ±ÛŒ Ù…Ø´ØªÙ‚</h2>
                <p>Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ÛŒ Ø¯Ø± Ù‡Ù…Ø³Ø§ÛŒÚ¯ÛŒ Ù†Ù‚Ø·Ù‡ a ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ù…Ø´ØªÙ‚ Ø¢Ù† Ø¯Ø± Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡ Ø¨ØµÙˆØ±Øª Ø­Ø¯ Ø²ÛŒØ± ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯ Ú©Ù‡
                    Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø´ÛŒØ¨ Ø®Ø· Ù…Ù…Ø§Ø³ Ø§Ø³Øª:</p>
                <div class="math-card-v2">
                    f'(a) = lim<sub>hâ†’0</sub> [f(a + h) - f(a)] / h
                </div>

                <h2>Û². Ù‚Ø¶ÛŒÙ‡ Ù…Ù‚Ø¯Ø§Ø± Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†</h2>
                <p>Ø§ÛŒÙ† Ù‚Ø¶ÛŒÙ‡ Ø¨ÛŒØ§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ÛŒ Ø¯Ø± Ø¨Ø§Ø²Ù‡ [a, b] Ù¾ÛŒÙˆØ³ØªÙ‡ Ùˆ Ø¯Ø± (a, b) Ù…Ø´ØªÙ‚â€ŒÙ¾Ø°ÛŒØ± Ø¨Ø§Ø´Ø¯ØŒ Ù†Ù‚Ø·Ù‡â€ŒØ§ÛŒ Ù…Ø§Ù†Ù†Ø¯ c
                    Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ø´ÛŒØ¨ Ø®Ø· Ù…Ù…Ø§Ø³ Ø¯Ø± Ø¢Ù† Ø¨Ø§ Ø´ÛŒØ¨ Ø®Ø· ÙˆØ§ØµÙ„ Ø¯Ùˆ Ù†Ù‚Ø·Ù‡ Ø§Ø¨ØªØ¯Ø§ Ùˆ Ø§Ù†ØªÙ‡Ø§ Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª.</p>
                <div class="math-card-v2">
                    f'(c) = [f(b) - f(a)] / (b - a)
                </div>

                <h2>Û³. Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ù‚Ø§Ø· Ø¨Ø­Ø±Ø§Ù†ÛŒ</h2>
                <p>Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨ÛŒØ´ÛŒÙ†Ù‡ Ùˆ Ú©Ù…ÛŒÙ†Ù‡ØŒ Ø§Ø² Ù…Ø´ØªÙ‚ Ø§ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…. Ù†Ù‚Ø§Ø·ÛŒ Ú©Ù‡ Ù…Ø´ØªÙ‚ Ø¯Ø± Ø¢Ù†â€ŒÙ‡Ø§ ØµÙØ± ÛŒØ§ ØªØ¹Ø±ÛŒÙ
                    Ù†Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ù†Ù‚Ø§Ø· Ø¨Ø­Ø±Ø§Ù†ÛŒ Ù†Ø§Ù…ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù„Ø§Ù…Øª Ù…Ø´ØªÙ‚ Ø¯Ø± Ø·Ø±ÙÛŒÙ† Ø§ÛŒÙ† Ù†Ù‚Ø§Ø·ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ú©Ø³ØªØ±Ù…Ù…â€ŒÙ‡Ø§ Ø±Ø§
                    ØªØ¹ÛŒÛŒÙ† Ú©Ø±Ø¯.</p>

                <p>Ø¯Ø± Ù…Ø³Ø§Ø¦Ù„ Ø§Ù‚ØªØµØ§Ø¯ÛŒØŒ Ø§ÛŒÙ† Ù…ÙÙ‡ÙˆÙ… Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ù†Ù‚Ø·Ù‡ Ø³Ø±Ø¨Ù‡ Ø³Ø± Ùˆ Ø­Ø¯Ø§Ú©Ø«Ø± Ø³ÙˆØ¯ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø´ØªÙ‚ ØªØ§Ø¨Ø¹ Ù‡Ø²ÛŒÙ†Ù‡ Ùˆ
                    Ø¯Ø±Ø¢Ù…Ø¯ Ø¨Ú©Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆØ¯.</p>

                <button class="article-return-btn" onclick="returnToLogin()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</button>

                <div class="fake-return-dot" onclick="returnToLogin()">.</div>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu -->
    <div id="context-menu">
        <div class="menu-item" onclick="handleMenuAction('save')"><span>ğŸ’¾</span> Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ±</div>
        <div class="menu-item" onclick="handleMenuAction('sticker')"><span>âœ¨</span> Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§</div>
        <div class="menu-item" onclick="handleMenuAction('reply')"><span>â†©</span> Ù¾Ø§Ø³Ø® (Reply)</div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" onclick="closeImageModal()">
        <div class="modal-close">âœ•</div>
        <img id="modal-img" src="" alt="Full size">
    </div>

    <!-- Scripts -->
    <script>
        // Three.js and other initial scripts remain the same
        const scene = new THREE.Scene();
        // ... (Ú©Ø¯Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ three.js Ùˆ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯)
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById("canvas-container").appendChild(renderer.domElement);
        const particlesGeometry = new THREE.BufferGeometry();
        const count = 5000;
        const positions = new Float32Array(count * 3);
        for (let i = 0; i < count * 3; i++) positions[i] = (Math.random() - 0.5) * 100;
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const particlesMaterial = new THREE.PointsMaterial({ color: "#00ffa7", size: 0.1 });
        const particles = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particles);
        const light = new THREE.PointLight(0xffffff, 1, 1000);
        light.position.set(10, 10, 10);
        scene.add(light);
        const loader = new THREE.FontLoader();
        loader.load('spike.json', function (font) {
            const geometry = new THREE.TextGeometry('TAHA ZOLFI', {
                font: font, size: 1, height: 0.2, curveSegments: 12, bevelEnabled: true, bevelThickness: 0.03, bevelSize: 0.02, bevelSegments: 5
            });
            geometry.center();
            const material = new THREE.MeshStandardMaterial({ color: 0x00ffa7 });
            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }, undefined, function () { });
        camera.position.z = 5;
        let isSecretActive = false;
        function animate() {
            requestAnimationFrame(animate);
            if (isSecretActive) return;
            particles.rotation.y += 0.001;
            renderer.render(scene, camera);
        }
        animate();

        document.addEventListener('DOMContentLoaded', () => {
            const nav = document.querySelector('.nav');
            let lastScrollTop = 0;
            window.addEventListener('scroll', () => {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop) nav.classList.add('hidden');
                else nav.classList.remove('hidden');
                lastScrollTop = scrollTop;
            });
        });
        const swiper = new Swiper('.swiper', {
            speed: 300, spaceBetween: 100, loop: true, autoplay: { delay: 1000 },
            grabCursor: true, centeredSlides: true,
            breakpoints: { 320: { slidesPerView: 3, spaceBetween: 20 }, 480: { slidesPerView: 3, spaceBetween: 30 }, 640: { slidesPerView: 4, spaceBetween: 40 } }
        });
    </script>

    <!-- =======================================================
               FIXED & IMPROVED Supabase and Chat Scripts
         ======================================================= -->
    <script>
        let currentUser = 'user-' + Math.random().toString(36).substring(2, 9);
        let channel;
        let deleteTimers = {};
        let replyingTo = null;

        const STICKERS = [
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PnM/3o7TKVUn7iM8FMEU24/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PnM/3o7TKMGVpEwVGHl0mA/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PnM/l0HlIDl0HlIDl0HlIE/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PnM/l0HlIDl0HlIDl0HlIE/giphy.gif'
        ];
        const GIFS = [
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PWc/3o7TKVUn7iM8FMEU24/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PWc/l41lTfG_hGP982BAk/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PWc/3o7TKMGVpEwVGHl0mA/giphy.gif',
            'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JnB0PWEmZXA9djFfaW50ZXJuYWxfZ2lmX2J5X2lkJmN0PWc/l0HlGVDp1S3TzGq5C/giphy.gif'
        ];

        function openKetabino() {
            isSecretActive = true;
            document.getElementById('secret-container').style.display = 'block';
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('chat-view').style.display = 'none';
            document.getElementById('panic-view').style.display = 'none';
            document.body.style.overflow = 'hidden';
        }

        function closeKetabino() {
            isSecretActive = false;
            document.getElementById('secret-container').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function triggerPanic() {
            document.getElementById('chat-view').style.display = 'none';
            document.getElementById('panic-view').style.display = 'block';
            document.getElementById('chat-area').innerHTML = '';
            if (channel) {
                channel.send({ type: 'broadcast', event: 'clear_chat', payload: {} });
            }
        }

        function returnToLogin() {
            document.getElementById('panic-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('secret-pass').value = '';
        }

        function toEnglishDigits(str) {
            return str.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
        }

        const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        function playJoinSound() {
            if (isMobile()) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') audioContext.resume();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) { }
        }

        const SUPABASE_URL = 'https://oklfwsnkaxbqlnjpownj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rbGZ3c25rYXhicWxuanBvd25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTkwMTAsImV4cCI6MjA3MzY3NTAxMH0.apanbRV3o5afJ5ivDHimjvYQY1JqawWcIsGemW0jyMg';

        let db;
        try { db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error(e); }

        const validPasswords = ['914920', '920914'];

        function checkSecretPass() {
            let input = document.getElementById('secret-pass').value;
            input = toEnglishDigits(input);
            if (validPasswords.includes(input)) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('chat-view').style.display = 'flex';
                initChat();
            } else {
                const err = document.getElementById('login-error');
                err.style.display = 'block';
                setTimeout(() => err.style.display = 'none', 3000);
            }
        }

        function startMessageTimer(id, seconds = 60) {
            const timerEl = document.querySelector(`#msg-${id} .timer-val`);
            if (!timerEl) return;

            let remaining = seconds;
            const interval = setInterval(() => {
                remaining--;
                if (timerEl) timerEl.textContent = remaining + 's';
                if (remaining <= 0) {
                    clearInterval(interval);
                    const msgEl = document.getElementById('msg-' + id);
                    if (msgEl) {
                        msgEl.style.opacity = '0';
                        msgEl.style.transform = 'scale(0.8)';
                        setTimeout(() => msgEl.remove(), 400);
                    }
                }
            }, 1000);
        }

        function renderMessage(msg, direction = 'incoming') {
            const chatArea = document.getElementById('chat-area');
            if (document.getElementById('msg-' + msg.id)) return;

            const div = document.createElement('div');
            div.id = 'msg-' + msg.id;
            div.className = `message msg-${direction}`;

            // Context Menu Listener
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Stop bubbling immediately
                showContextMenu(e.clientX, e.clientY, msg); // Use clientX/Y for viewport coords
            });

            // Long Press for Mobile with visual feedback
            let longPressTimer;
            let touchStartX = 0;
            let touchStartY = 0; // Track Y to detect scroll vs swipe
            let touchMoved = false;

            div.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchMoved = false;
                div.style.transition = 'transform 0.2s, opacity 0.2s';

                longPressTimer = setTimeout(() => {
                    if (!touchMoved) {
                        if (navigator.vibrate) navigator.vibrate(50);
                        div.style.transform = 'scale(0.97)';
                        div.style.opacity = '0.8';
                        showContextMenu(e.touches[0].clientX, e.touches[0].clientY, msg);
                        setTimeout(() => {
                            div.style.transform = '';
                            div.style.opacity = '';
                        }, 200);
                    }
                }, 500);
            }, { passive: true });

            div.addEventListener('touchmove', (e) => {
                const deltaX = e.touches[0].clientX - touchStartX;
                const deltaY = e.touches[0].clientY - touchStartY;

                // If moved significantly in any direction, cancel long press
                if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                    touchMoved = true;
                    clearTimeout(longPressTimer);
                }

                // Swipe to reply (swipe right) - Only if mostly horizontal
                if (deltaX > 70 && Math.abs(deltaY) < 30 && !touchMoved) {
                    touchMoved = true; // Prevent multiple triggers
                    setReply(msg);
                    if (navigator.vibrate) navigator.vibrate(30);
                }
            }, { passive: true });

            div.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
                div.style.transform = '';
                div.style.opacity = '';
            });

            // Double tap for reaction
            let lastTap = 0;
            div.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTap < 300) {
                    addReaction(div, msg);
                }
                lastTap = now;
            });


            let innerContent = '';
            let replyHtml = '';

            if (msg.reply_id) {
                replyHtml = `
                    <div class="msg-reply-info" onclick="scrollToMessage('${msg.reply_id}')">
                        <span class="reply-sender">${msg.reply_sender === currentUser ? 'Ø´Ù…Ø§' : 'Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±'}</span>
                        <span class="reply-text-snippet">${msg.reply_text}</span>
                    </div>
                `;
            }

            if (msg.type === 'image' || msg.type === 'sticker' || msg.type === 'gif') {
                innerContent = `<img src="${msg.content}" onclick="openImageModal('${msg.content}')" onerror="this.src='https://placehold.co/200?text=Error'">`;
            } else {
                innerContent = `<div>${msg.content}</div>`;
            }

            // Read receipts for outgoing
            const readReceipt = direction === 'outgoing' ? '<span class="read-receipts">âœ“âœ“</span>' : '';

            div.innerHTML = `
                ${replyHtml}
                ${innerContent}
                <div class="msg-timer-wrap">
                    ${readReceipt}
                    <span>â±</span>
                    <span class="timer-val">60s</span>
                </div>
            `;


            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            startMessageTimer(msg.id, 60);
        }

        async function sendMessage(type = 'text', content = null) {
            if (!db || !channel) return;
            const textInput = document.getElementById('msg-input');
            const msgContent = content || textInput.value;
            if (!msgContent.trim()) return;

            if (type === 'text') textInput.value = '';

            const msgId = 'm-' + Math.random().toString(36).substring(2, 9);
            const msgData = {
                id: msgId,
                content: msgContent,
                type: type,
                sender: currentUser,
                created_at: new Date().toISOString()
            };

            if (replyingTo) {
                msgData.reply_id = replyingTo.id;
                msgData.reply_text = replyingTo.type === 'text' ? replyingTo.content : 'ØªØµÙˆÛŒØ±/ÙØ§ÛŒÙ„';
                msgData.reply_sender = replyingTo.sender;
                cancelReply();
            }

            renderMessage(msgData, 'outgoing');
            channel.send({ type: 'broadcast', event: 'new_msg', payload: msgData });
            db.from('messages').insert([{ content: msgContent, type: type }]).then(() => { });
        }

        // --- New Features Logic ---

        // Reaction system
        function addReaction(element, msg) {
            // Check if reaction already exists
            if (element.querySelector('.msg-reaction')) return;

            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate([20, 50, 20]);

            // Create reaction element
            const reaction = document.createElement('div');
            reaction.className = 'msg-reaction';
            reaction.innerHTML = 'â¤ï¸';
            reaction.style.cssText = `
                position: absolute;
                bottom: -8px;
                right: 10px;
                background: #1a1f2e;
                border: 2px solid #ff4757;
                border-radius: 50%;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                animation: reactionPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                cursor: pointer;
                z-index: 10;
            `;

            // Double tap to remove
            reaction.onclick = () => {
                reaction.style.animation = 'reactionPop 0.2s reverse';
                setTimeout(() => reaction.remove(), 200);
            };

            element.style.position = 'relative';
            element.appendChild(reaction);

            showToast('â¤ï¸ Ø±ÛŒÚ©Ø´Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }

        function setReply(msg) {

            replyingTo = msg;
            const container = document.getElementById('reply-container');
            const text = document.getElementById('reply-text');
            container.style.display = 'block';
            text.textContent = msg.type === 'text' ? msg.content : 'ØªØµÙˆÛŒØ±/ÙØ§ÛŒÙ„';
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('reply-container').style.display = 'none';
        }

        function scrollToMessage(id) {
            const el = document.getElementById('msg-' + id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.boxShadow = '0 0 20px var(--accent)';
                setTimeout(() => el.style.boxShadow = '', 1500);
            }
        }

        // Voice button (UI simulation)
        let voiceRecording = false;
        function startVoice() {
            voiceRecording = true;
            const btn = document.getElementById('voice-btn');
            btn.classList.add('recording');
            if (navigator.vibrate) navigator.vibrate(50);
            showToast('ğŸ¤ Ø¶Ø¨Ø· ØµØ¯Ø§ Ø´Ø±ÙˆØ¹ Ø´Ø¯...');
        }

        function stopVoice() {
            if (!voiceRecording) return;
            voiceRecording = false;
            const btn = document.getElementById('voice-btn');
            btn.classList.remove('recording');
            if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
            showToast('ğŸ¤ Ø¶Ø¨Ø· ØµØ¯Ø§ Ù…ØªÙˆÙ‚Ù Ø´Ø¯ (UI Only)');
        }


        // Real Desktop Notification
        function notifyUserJoined() {
            if (!("Notification" in window)) return;

            if (Notification.permission === "granted") {
                new Notification("Ú©ØªØ§Ø¨ÛŒÙ†Ùˆ", { body: "ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯!", icon: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png" });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") notifyUserJoined();
                });
            }
        }

        // --- Advanced Sticker Panel ---
        let stickerDeleteMode = false;

        function toggleExtraPanel(type) {
            const panel = document.getElementById('extra-panel');
            // If clicking outside while open is handled by document listener

            if (panel.classList.contains('active')) {
                // If switching tab
                const currentType = document.querySelector('.panel-tab.active').innerText.includes('Ø§Ø³ØªÛŒÚ©Ø±') ? 'stickers' : 'gifs';
                if ((type === 'stickers' && currentType === 'stickers') || (type === 'gifs' && currentType === 'gifs')) {
                    panel.classList.remove('active');
                } else {
                    switchPanelTab(type);
                }
            } else {
                panel.classList.add('active');
                switchPanelTab(type || 'stickers');
            }
        }

        function switchPanelTab(type) {
            stickerDeleteMode = false; // Reset mode
            const tabs = document.querySelectorAll('.panel-tab');
            tabs.forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(tabs).find(t => t.innerText.includes(type === 'stickers' ? 'Ø§Ø³ØªÛŒÚ©Ø±' : 'Ú¯ÛŒÙ'));
            if (activeTab) activeTab.classList.add('active');

            renderPanelContent(type);
        }

        function renderPanelContent(type) {
            const content = document.getElementById('panel-content');
            content.innerHTML = '';

            // Add Header with controls
            const header = document.createElement('div');
            header.style.cssText = 'grid-column: 1/-1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #aaa; font-size: 0.8rem;';
            header.innerHTML = `
                <span>${type === 'stickers' ? 'Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ÛŒ Ù…Ù†' : 'Ú¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨'}</span>
                <span onclick="toggleDeleteMode('${type}')" style="cursor: pointer; color: #ff6b6b;">${stickerDeleteMode ? 'Ù„ØºÙˆ Ø­Ø°Ù' : 'Ø­Ø°Ù/ÙˆÛŒØ±Ø§ÛŒØ´'}</span>
            `;
            content.appendChild(header);

            const items = type === 'stickers' ? STICKERS : GIFS;

            items.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = 'panel-item';
                item.style.position = 'relative'; // Ensure positioning context for X button

                // Shake effect if delete mode
                if (stickerDeleteMode) item.style.animation = 'shake 0.3s infinite';

                // Image
                const img = document.createElement('img');
                img.src = url;
                item.appendChild(img);

                // Main Click (Send)
                item.onclick = () => {
                    if (!stickerDeleteMode) {
                        sendMessage(type === 'stickers' ? 'sticker' : 'gif', url);
                        document.getElementById('extra-panel').classList.remove('active');
                    }
                };

                // Delete Button (Only in delete mode)
                if (stickerDeleteMode) {
                    const deleteBtn = document.createElement('div');
                    deleteBtn.innerHTML = 'âœ•';
                    deleteBtn.style.cssText = `
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: #ff4757;
                        color: white;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        font-size: 14px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        cursor: pointer;
                        z-index: 10;
                    `;

                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // Stop it from triggering the item click
                        if (confirm('Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                            items.splice(index, 1);
                            renderPanelContent(type); // Re-render to update indices
                        }
                    };
                    item.appendChild(deleteBtn);
                }

                content.appendChild(item);
            });
        }

        function toggleDeleteMode(type) {
            stickerDeleteMode = !stickerDeleteMode;
            renderPanelContent(type);
        }

        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('extra-panel');
            const btn = document.getElementById('sticker-btn');

            if (panel.classList.contains('active') && !panel.contains(e.target) && e.target !== btn) {
                panel.classList.remove('active');
            }
        });


        // Context Menu
        let selectedMsg = null;
        function showContextMenu(x, y, msg) {
            selectedMsg = msg;
            const menu = document.getElementById('context-menu');

            // Haptic feedback moved to trigger level for faster response

            menu.style.display = 'block';

            // Smart Positioning (similar to desktop OS context menus)
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;

                // Default to right-down
                let finalX = x;
                let finalY = y;

                // If overflows right, shift left
                if (x + rect.width > winWidth) {
                    finalX = x - rect.width;
                }

                // If overflows bottom, shift up
                if (y + rect.height > winHeight) {
                    finalY = y - rect.height;
                }

                // Safety bound (never off screen)
                if (finalX < 10) finalX = 10;
                if (finalY < 10) finalY = 10;

                menu.style.left = finalX + 'px';
                menu.style.top = finalY + 'px';
            }, 0);
        }


        // Close menu only when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('context-menu');
            if (menu.style.display === 'block' && !menu.contains(e.target)) {
                menu.style.display = 'none';
            }
        });


        function handleMenuAction(action) {
            if (!selectedMsg) return;
            if (action === 'reply') {
                setReply(selectedMsg);
            } else if (action === 'save') {
                if (selectedMsg.type === 'image' || selectedMsg.type === 'sticker' || selectedMsg.type === 'gif') {
                    const link = document.createElement('a');
                    link.href = selectedMsg.content;
                    link.download = 'image.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    showToast('Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… ØªØµÙˆÛŒØ± Ù†ÛŒØ³Øª');
                }
            } else if (action === 'sticker') {
                showToast('Ø¯Ø± Ø§Ø³ØªÛŒÚ©Ø±Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            }
        }

        // Modal
        function openImageModal(url) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-img');
            img.src = url;
            modal.style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        // --- Existing Typing Logic ---
        let typingTimeout;
        let lastTrackTime = 0;
        document.getElementById('msg-input').addEventListener('input', () => {
            if (!channel) return;
            const now = Date.now();
            if (now - lastTrackTime > 600) {
                channel.track({ typing: true, user: currentUser });
                lastTrackTime = now;
            }
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                channel.track({ typing: false, user: currentUser });
            }, 2500);
        });

        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function uploadImage() {
            if (!db) return;
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            if (!file) return;
            const fileName = Date.now() + '_' + file.name;
            const { error } = await db.storage.from('images').upload(fileName, file);
            if (error) return;
            const { data: { publicUrl } } = db.storage.from('images').getPublicUrl(fileName);
            sendMessage('image', publicUrl);
        }

        function showToast(text) {
            const toast = document.createElement('div');
            toast.className = 'toast-notify';
            toast.textContent = text;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        let lastJoinTime = 0;
        function initChat() {
            if (!db) return;
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = '';
            channel = db.channel('realtime-ops', {
                config: {
                    presence: { key: currentUser },
                    broadcast: { self: false }
                }
            });

            channel
                .on('broadcast', { event: 'new_msg' }, payload => {
                    renderMessage(payload.payload, 'incoming');
                    playJoinSound();
                    showToast('Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
                })
                .on('broadcast', { event: 'clear_chat' }, () => {
                    document.getElementById('chat-area').innerHTML = '';
                    showToast('Ú¯ÙØªÚ¯Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯');
                })
                .on('presence', { event: 'sync' }, () => {
                    const state = channel.presenceState();
                    const count = Object.keys(state).length;
                    document.getElementById('online-count').textContent = count + ' Ù†ÙØ± Ø¢Ù†Ù„Ø§ÛŒÙ†';

                    let isAnyTyping = false;
                    for (const id in state) {
                        state[id].forEach(u => {
                            if (u.typing && id !== currentUser) isAnyTyping = true;
                        });
                    }
                    const typingPill = document.getElementById('typing-status');
                    typingPill.style.display = isAnyTyping ? 'block' : 'none';
                    typingPill.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...';
                })
                .on('presence', { event: 'join' }, ({ key }) => {
                    const now = Date.now();
                    if (key !== currentUser && (now - lastJoinTime > 10000)) {
                        lastJoinTime = now;
                        showToast('ÛŒÚ© Ù†ÙˆØ¯ Ø¬Ø¯ÛŒØ¯ Ù…ØªØµÙ„ Ø´Ø¯');
                        playJoinSound();
                    }
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({ online_at: new Date().toISOString(), typing: false });
                    }
                });

            const handleViewportChange = () => {
                if (window.visualViewport) {
                    const container = document.getElementById('secret-container');
                    if (container) {
                        container.style.height = window.visualViewport.height + 'px';
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }
                }
            };
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', handleViewportChange);
                window.visualViewport.addEventListener('scroll', handleViewportChange);
            }
            document.getElementById('msg-input').addEventListener('focus', () => {
                setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 300);
            });
        }

    </script>
</body>

</html>
